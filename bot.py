from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    CallbackQueryHandler,
    ContextTypes,
    MessageHandler,
    filters
)
import os
import logging
from datetime import datetime

# Настройка логирования
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

PORT = int(os.environ.get('PORT', 8000))
TOKEN = '8159127478:AAHwjKl3zeZ3LZ4RgJgZ9X4Y1WOOKQFyZww'
ADMIN_CHAT_IDS = ['79100904945', '79032587332']  # ID менеджера и администратора

# ========== ДАННЫЕ О ТОВАРАХ ==========
categories = [
    {"id": "1", "name": "Снегозадержатели"},
    {"id": "2", "name": "Кровельные ограждения"},
    {"id": "3", "name": "Пожарные лестницы"},
    {"id": "4", "name": "Лестницы"},
    {"id": "5", "name": "Переходные мостики"}
]

products = {
    "1": [
        {
            "id": "1_1",
            "name": "СТС «ПРОФ»",
            "description": (
                "Снегозадержатель СТС «ПРОФ» длиной 3000 мм предназначен для кровель из профнастила выше НС40 и сендвич-панели любого производителя.\n\n"
                "Снегозадержатель соответствует требованиям ГОСТ.\n\n"
                "Комплектация:\n"
                "1. Труба плоскоовал Zn 45×25 – 2 шт.\n"
                "2. Кронштейн усиленный СТС с герметичной бутило-каучуковой лентой, оцинкованный, толщина металла 2 мм – 4 шт.\n"
                "3. Заглушки 45х25 – 4 шт."
            ),
            "specs": ["Кровля из сэндвич панели", "Кровля из профнастила высокой волны"],
            "coating": ["Цинк", "Цинк+краска"],
            "price": {"Цинк": 3475, "Цинк+краска": 3735},
            "photo": "СТС «ПРОФ».jpg"
        },
        {
            "id": "1_2",
            "name": "СТС «Усиленный универсальный»",
            "description": (
                "Снегозадержатель СТС «Усиленный универсальный» длиной 3000 мм и подходит для всех видов кровельных материалов.\n\n"
                "Имеет улучшенную конструкцию из усиленного кронштейна и плоскоовальной трубы, что позволяет выдерживать большие нагрузки. "
                "Толщина металла трубы не менее 1,5 мм толщина металла кронштейна не менее 2 мм. Подходит для снеговых районов с повышенной снеговой нагрузкой >200 кг/м2.\n\n"
                "Снегозадержатель соответствует требованиям ГОСТ.\n\n"
                "Комплектация:\n"
                "1. Труба оцинкованная плоскоовал 45×25 мм—2 шт.\n"
                "2. Кронштейн «СТС» оцинкованный толщина метала 2 мм—4 шт.\n"
                "3. Крепеж—1 комплект:\n"
                "   • Саморез для крепления лаг и реек 8×60—8 шт.\n"
                "   • Резиновая прокладка 10×30—8 шт.\n"
                "   • Заглушки пластиковые 45×25—4 шт."
            ),
            "specs": ["Универсальное крепление"],
            "coating": ["Цинк", "Цинк+краска"],
            "price": {"Цинк": 4200, "Цинк+краска": 4500},
            "photo": "СТС «Усиленный универсальный».jpg"
        },
        {
            "id": "1_3",
            "name": "СТС «Усиленный фальц»",
            "description": (
                "Снегозадержатель СТС «Усиленный фальц» длиной 3000 мм предназначен для фальцевых видов кровли.\n\n"
                "Имеет улучшенную конструкцию из усиленного кронштейна и плоскоовальной трубы, что позволяет выдерживать большие нагрузки. "
                "Толщина металла трубы не менее 1,5 мм толщина металла кронштейна не менее 2 мм. Подходит для снеговых районов с повышенной снеговой нагрузкой >200 кг/м2.\n\n"
                "Снегозадержатель соответствует требованиям ГОСТ.\n\n"
                "Комплектация:\n"
                "1. Труба оцинкованная плоскоовал 45×25 мм—2 шт.\n"
                "2. Кронштейн «СТС» оцинкованный толщина метала 2 мм—4 шт.\n"
                "3. Крепеж—1 комплект:\n"
                "   • Саморез для крепления лаг и реек 8×60—8 шт.\n"
                "   • Резиновая прокладка 10×30—8 шт.\n"
                "   • Заглушки пластиковые 45×25—4 шт.\n"
                "4. Прижимные планки—1 комплект. (для фальцевой кровли, крепление 2)"
            ),
            "specs": ["Фальцевая кровля"],
            "coating": ["Цинк", "Цинк+краска"],
            "price": {"Цинк": 4300, "Цинк+краска": 4600},
            "photo": "СТС «Усиленный фальц».jpg"
        },
        {
            "id": "1_4",
            "name": "СТС «Универсальный»",
            "description": (
                "Снегозадержатель СТС «Универсальный» длиной 3000 мм подходит для всех видов кровельных материалов. Он предотвращает внезапный сход снега с крыши и обеспечивает безопасность зимой.\n\n"
                "Снегозадержатель соответствует требованиям ГОСТ.\n\n"
                "Комплектация:\n"
                "1. Труба оцинкованная круглая Ф25 мм – 2 шт.\n"
                "2. Кронштейн «универсальный» оцинкованный толщина металла 1,5 мм – 4 шт.\n"
                "3. Крепеж – 1 комплект:\n"
                "   • Саморез для крепления лаг и реек 8×60 – 8 шт.\n"
                "   • Резиновая прокладка 10×30 – 8 шт.\n"
                "   • Заглушки пластиковые Ф25 мм – 4 шт."
            ),
            "specs": ["Универсальное крепление"],
            "coating": ["Цинк", "Цинк+краска"],
            "price": {"Цинк": 3800, "Цинк+краска": 4100},
            "photo": "СТС «Универсальный».jpg"
        },
        {
            "id": "1_5",
            "name": "СТС «Фальц»",
            "description": (
                "Снегозадержатель СТС «Фальц» длиной 3000 мм предназначен для фальцевых видов кровли. Он предотвращает лавинообразный сход снега и обеспечивает безопасность в зимнее время.\n\n"
                "Снегозадержатель соответствует требованиям ГОСТ.\n\n"
                "Комплектация:\n"
                "1. Труба оцинкованная круглая Ф25 мм – 2 шт.\n"
                "2. Кронштейн «универсальный» оцинкованный толщина металла 1,5 мм – 4 шт.\n"
                "3. Крепеж – 1 комплект:\n"
                "   • Саморез для крепления лаг и реек 8×60 – 8 шт.\n"
                "   • Резиновая прокладка 10×30 – 8 шт.\n"
                "   • Заглушки пластиковые Ф25 мм – 4 шт.\n"
                "4. Прижимные планки – 1 комплект. (для фальцевой кровли, крепление 2)"
            ),
            "specs": ["Фальцевая кровля"],
            "coating": ["Цинк", "Цинк+краска"],
            "price": {"Цинк": 3900, "Цинк+краска": 4200},
            "photo": "СТС «Фальц».jpg"
        },
        {
            "id": "1_6",
            "name": "СТС «Решетчатый универсальный»",
            "description": (
                "Снегозадержатель СТС «Решетчатый универсальный» имеет длину 2500 мм и подходит для всех видов кровельных материалов. Он надежно удерживает снег на крыше и предотвращает его лавинообразный сход.\n\n"
                "Снегозадержатель соответствует требованиям ГОСТ.\n\n"
                "Комплектация:\n"
                "1. Панель решетчатая толщина металла 1.5 мм – 1 шт.\n"
                "2. Кронштейн решетчатого СЗ оцинкованный толщина металла 2 мм – 4 шт.\n"
                "3. Крепеж – 1 комплект:\n"
                "   • Саморез для крепления лаг и реек 8×60 – 8 шт.\n"
                "   • Резиновая прокладка 10×30 – 8 шт.\n"
                "   • Болт М8×30 – 12 шт.\n"
                "   • Гайка М8 – 12 шт.\n"
                "   • Шайба Ф8 мм увеличенная – 12 шт."
            ),
            "specs": ["Универсальное крепление"],
            "coating": ["Цинк", "Цинк+краска"],
            "price": {"Цинк": 4000, "Цинк+краска": 4300},
            "photo": "СТС «Решетчатый универсальный».jpg"
        },
        {
            "id": "1_7",
            "name": "СТС «Решётчатый фальц»",
            "description": (
                "Снегозадержатель СТС «Решётчатый фальц» имеет длину 2500 мм и предназначен для использования с фальцевой кровлей.\n\n"
                "Снегозадержатель соответствует требованиям ГОСТ.\n\n"
                "Комплектация:\n"
                "1. Панель решетчатая толщина металла 1.5 мм – 1 шт.\n"
                "2. Кронштейн решетчатого СЗ оцинкованный толщина металла 2 мм – 4 шт.\n"
                "3. Крепеж – 1 комплект:\n"
                "   • Саморез для крепления лаг и реек 8×60 – 8 шт.\n"
                "   • Резиновая прокладка 10×30 – 8 шт.\n"
                "   • Болт М8×30 – 12 шт.\n"
                "   • Гайка М8 – 12 шт.\n"
                "   • Шайба Ф8 мм увеличенная – 12 шт.\n"
                "4. Прижимные планки – 1 комплект (для фальцевой кровли, крепление 2)"
            ),
            "specs": ["Фальцевая кровля"],
            "coating": ["Цинк", "Цинк+краска"],
            "price": {"Цинк": 4100, "Цинк+краска": 4400},
            "photo": "СТС «Решётчатый фальц».jpg"
        },
        {
            "id": "1_8",
            "name": "СТС «Фигурный универсальный»",
            "description": (
                "Снегозадержатель СТС «Фигурный универсальный» имеет длину 3000 мм и подходит для всех видов кровельных материалов. Вы можете выбрать одну из четырех фигурок: бык, волк, кошка или петух. Он надежно удерживает снег на крыше и предотвращает его лавинообразный сход.\n\n"
                "Снегозадержатель соответствует требованиям ГОСТ.\n\n"
                "Комплектация:\n"
                "1. Труба оцинкованная круглая Ф25 мм – 2 шт.\n"
                "2. Кронштейн СТС «фигурный» (петух, кошка, волк, бык) оцинкованный толщина металла 2 мм – 4 шт.\n"
                "3. Крепеж – 1 комплект:\n"
                "   • Саморез для крепления лаг и реек 8×60 – 8 шт.\n"
                "   • Резиновая прокладка 10×30 – 8 шт.\n"
                "   • Заглушки пластиковые Ф25 мм – 4 шт."
            ),
            "specs": ["Универсальное крепление"],
            "coating": ["Цинк", "Цинк+краска"],
            "price": {"Цинк": 4200, "Цинк+краска": 4500},
            "photo": "СТС «Фигурный универсальный».jpg"
        },
        {
            "id": "1_9",
            "name": "СТС «Фигурный фальц»",
            "description": (
                "Снегозадержатель СТС «Фигурный фальц» подходит для всех видов кровельных материалов, и вы можете выбрать одну из четырех фигурок: бык, волк, кошка или петух.\n\n"
                "Снегозадержатель соответствует требованиям ГОСТ.\n\n"
                "Комплектация:\n"
                "1. Труба оцинкованная круглая Ф25 мм – 2 шт.\n"
                "2. Кронштейн СТС «фигурный» (петух, кошка, волк, бык) оцинкованный толщина металла 2 мм – 4 шт.\n"
                "3. Крепеж – 1 комплект:\n"
                "   • Саморез для крепления лаг и реек 8×60 – 8 шт.\n"
                "   • Резиновая прокладка 10×30 – 8 шт.\n"
                "   • Заглушки пластиковые Ф25 мм – 4 шт.\n"
                "4. Прижимные планки – 1 комплект (для фальцевой кровли)"
            ),
            "specs": ["Фальцевая кровля"],
            "coating": ["Цинк", "Цинк+краска"],
            "price": {"Цинк": 4300, "Цинк+краска": 4600},
            "photo": "СТС «Фигурный фальц».jpg"
        }
    ],
    "2": [
        {
            "id": "2_1",
            "name": "СТС «Для ПВХ кровель»",
            "description": (
                "Данное ограждение разработано специально для ПВХ кровли. Оно имеет специальную манжету для сварки с ПВХ мембраной, что обеспечивает 100% герметичность. Ограждение производится длиной 3 000 мм также есть доборные элементы 1000 мм.\n\n"
                "Высота кровельного ограждения и количество поперечных труб бывает:\n"
                "• H=600 мм (2 поперечные трубы)\n"
                "• H=800 мм (2 или 3 поперечные трубы)\n"
                "• H=1200 мм (2 или 3 поперечные трубы)\n\n"
                "Кровельное ограждение для ПВХ кровель соответствует требованиям ГОСТ.\n\n"
                "Комплектация:\n"
                "1. Труба оцинкованная Ф25 мм – 2 шт. или 3 шт.\n"
                "2. Кронштейн ограждения «ПРОФ» толщина метала 2 мм с герметичной бутил-каучуковой лентой у основания – 3 шт.\n"
                "3. Стойка ограждения Ф51 оцинкованная, толщина металла 1,5 мм (600, 800,1200) – 3 шт.\n"
                "4. Укос 30×30 оцинкованный, толщина металла 1,5 мм – 1 шт.\n"
                "5. Крепеж сборочный – 1 комплект:\n"
                "   • Стыковочные планки – 2, 3 шт.\n"
                "   • Болт М8×60 + гайка М8 – 6 шт.\n"
                "   • Саморез 5,5×25 – 12 шт.\n"
                "   • Хомут крепления трубы с ограждением – 6, 9 шт.\n"
                "6. Заглушка пластиковая Ф50 – 3 шт."
            ),
            "specs": ["ПВХ кровля"],
            "coating": ["Цинк", "Цинк+краска"],
            "price": {"Цинк": 5200, "Цинк+краска": 5600},
            "photo": "СТС «Для ПВХ кровель».jpg"
        },
        {
            "id": "2_2",
            "name": "Кровельное ограждение СТС «ПРОФ»",
            "description": (
                "Кровельное ограждение СТС «ПРОФ» предназначен для кровель из профнастила выше НС40 и сендвич-панели любого производителя. Доступно в восьми вариантах с одинаковой длиной 3 м и различной высотой. Варианты для сэндвич-панелей: 0,6 м – две поперечные трубы, 0,8 м и 1,2 м – по две трубы, 1,2 м с тремя трубами. Варианты для профнастила: 0,6, 0,8 и 1,2 м – по две поперечные трубы, 1,2 м – три трубы. Обеспечивают безопасность при нахождении на крыше.\n\n"
                "Кровельное ограждение соответствует требованиям ГОСТ.\n\n"
                "Комплектация:\n"
                "1. Труба оцинкованная Ф25 мм – 2 шт, 3 шт.\n"
                "2. Кронштейн ограждения «ПРОФ» оцинкованный, толщина метала 2 мм с герметичной бутил-каучуковой лентой у основания – 3 шт.\n"
                "3. Стойка ограждения 45×30 оцинкованная, толщина металла 2 мм (600, 800, 1200) – 3 шт.\n"
                "4. Укос 30×30 оцинкованный, толщина металла 1,5 мм – 1 шт.\n"
                "5. Крепеж сборочный – 1 комплект:\n"
                "   • Стыковочные планки – 2 шт.\n"
                "   • Болт М10×20 + гайка М10 – 9 шт.\n"
                "   • Саморез 5,5×25 – 11 шт."
            ),
            "specs": ["Профнастил", "Сэндвич-панели"],
            "coating": ["Цинк", "Цинк+краска"],
            "price": {"Цинк": 5300, "Цинк+краска": 5700},
            "photo": "Кровельное ограждение СТС «ПРОФ».jpg"
        },
        {
            "id": "2_3",
            "name": "Кровельное ограждение комбинированное СТС «ПРОФ»",
            "description": (
                "Кровельное ограждение комбинированное СТС «ПРОФ» предназначен для кровель из профнастила выше НС40 и сендвич-панели любого производителя. Доступно в восьми вариантах с одинаковой длиной 3 м и различной высотой. Варианты для сэндвич-панелей: 60 см – две поперечные трубы, 80 см и 1.2 м – по две трубы, 1.2 м с тремя трубами. Варианты для профнастила: 60, 80 и 120 см – по две поперечные трубы, 1.2 м – три трубы. Обеспечивают безопасность при нахождении на крыше.\n\n"
                "Кровельное ограждение комбинированное соответствует требованиям ГОСТ.\n\n"
                "Комплектация:\n"
                "1. Труба оцинкованная Ф25 мм – 2 шт., 3 шт.\n"
                "2. Труба плоскоовал Ф45×25 мм – 2 шт.\n"
                "3. Кронштейн ограждения «ПРОФ» оцинкованный, толщина метала 2 мм с герметичной бутил-каучуковой лентой у основания – 4 шт.\n"
                "4. Стойка ограждения 45×30 оцинкованная, толщина металла 2 мм. (600, 800, 1200) – 4 шт.\n"
                "5. Укос 30×30 оцинкованный, толщина металла 1,5 мм – 1 шт.\n"
                "6. Крепеж сборочный – 1 комплект:\n"
                "   • Стыковочные планки – 2 шт.\n"
                "   • Болт М10×20 + гайка М10 – 9 шт.\n"
                "   • Саморез 5,5×25 – 11 шт.\n"
                "   • Золушки пластиковые 45х25 мм – 4 шт."
            ),
            "specs": ["Профнастил", "Сэндвич-панели"],
            "coating": ["Цинк", "Цинк+краска"],
            "price": {"Цинк": 5400, "Цинк+краска": 5800},
            "photo": "Кровельное ограждение комбинированное СТС «ПРОФ».jpg"
        },
        {
            "id": "2_4",
            "name": "Кровельное ограждение СТС «Универсальное»",
            "description": (
                "Кровельное ограждение СТС «Универсальное» представлено в шести моделях длиной 3 метра с различной высотой: 60 см — 2 поперечные трубы, 80 см — две или три трубы, 120 см — две, три или четыре трубы. Ограждение подходит для любых видов кровельных покрытий и обеспечивает безопасность на крыше.\n\n"
                "Кровельное ограждение соответствует требованиям ГОСТ.\n\n"
                "Комплектация:\n"
                "1. Труба оцинкованная Ф25 мм – 2 шт.\n"
                "2. Кронштейн ограждения «СТС» оцинкованный, толщина метала 1,5 мм – 3 шт.\n"
                "3. Стойка ограждения 45×30, толщина металла 2 мм. (600, 800, 1200) – 3 шт.\n"
                "4. Укос 30×30 оцинкованный, толщина металла 1,5 мм – 1 шт.\n"
                "5. Крепеж сборочный – 1 комплект:\n"
                "   • Саморез для крепления лаг и реек 8×60 – 6 шт.\n"
                "   • Резиновая прокладка 30×10 – 6 шт.\n"
                "   • Стыковочные планки – 2, 3 шт.\n"
                "   • Болт М10×20 + гайка М10 – 7 шт.\n"
                "   • Саморез 5,5×25 – 10 шт.\n"
                "6. Прижимные планки – 1 комплект (для фальцевой кровли, крепление 1)"
            ),
            "specs": ["Универсальное крепление"],
            "coating": ["Цинк", "Цинк+краска"],
            "price": {"Цинк": 5500, "Цинк+краска": 5900},
            "photo": "Кровельное ограждение СТС «Универсальное».jpg"
        },
        {
            "id": "2_5",
            "name": "Кровельное ограждение СТС «Фальц»",
            "description": (
                "Кровельное ограждение СТС «Фальц» также доступно в шести вариантах с длиной 3 метра и различной высотой: 60 сантиметров – 2 поперечных трубы; 80 сантиметров – 2 трубы; 1,2 метра – две, три и четыре трубы. Предназначено для фальцевой кровли.\n\n"
                "Кровельное ограждение «Фальц» соответствует требованиям ГОСТ.\n\n"
                "Комплектация:\n"
                "1. Труба оцинкованная Ф25 мм (2, 3, 4) шт. Длина – 3 м.\n"
                "2. Кронштейн ограждения «СТС» оцинкованный, толщина металла 2 мм – 8 шт.\n"
                "3. Стойка ограждения 45×30 оцинкованная, толщина металла 2 мм (600, 800, 1200) – 4 шт.\n"
                "4. Упор 600×30×30 оцинкованный, толщина металла 1,5 мм – 4 шт.\n"
                "5. Укос 30×30 оцинкованный, толщина металла 1,5 мм – 1 шт.\n"
                "6. Крепеж сборочный – 1 комплект:\n"
                "   • Стыковочные планки – 2 шт.\n"
                "   • Болт М10×20 + гайка М10 – 5 шт.\n"
                "   • Болт М8 + гайка М8 – 16 шт.\n"
                "   • Саморез 5,5×25 – 21 шт.\n"
                "   • Заглушка пластиковая Ф25 мм – 4 шт.\n"
                "7. Прижимные планки – 1 комплект – 8 шт."
            ),
            "specs": ["Фальцевая кровля"],
            "coating": ["Цинк", "Цинк+краска"],
            "price": {"Цинк": 5600, "Цинк+краска": 6000},
            "photo": "Кровельное ограждение СТС «Фальц».jpg"
        },
        {
            "id": "2_6",
            "name": "Кровельное ограждение комбинированное СТС «Универсальное» 4 опоры",
            "description": (
                "Кровельное ограждение комбинированное СТС «Универсальное» 4 опоры представлено в пяти моделях длиной 3 метра с различными высотами: 60 см – 2 поперечные трубы; 80 см – 2 трубы; 1,2 метра – 2 или 3 трубы и 1,2 метра с 4-мя трубами. Ограждение подходит для всех видов кровельных материалов.\n\n"
                "Кровельное ограждение комбинированное «Универсальное» соответствует требованиям ГОСТ.\n\n"
                "Комплектация:\n"
                "1. Труба оцинкованная Ф25 мм (2, 3, 4) шт.\n"
                "2. Кронштейн ограждения «СТС» оцинкованный, толщина металла 1,5 мм – 4 шт.\n"
                "3. Стойка ограждения 45×30 оцинкованная, толщина металла 2 мм (600, 800, 1200) – 4 шт.\n"
                "4. Укос 30×30 оцинкованный, толщина металла 1,5 мм – 1 шт.\n"
                "5. Крепеж – 1 комплект:\n"
                "   • Саморез для крепления лаг и реек 8×60 – 8 шт.\n"
                "   • Резиновая прокладка 30×10 – 8 шт.\n"
                "   • Стыковочные планки – 2 шт.\n"
                "   • Болт М10×20 + гайка М10 – 7 шт.\n"
                "   • Саморез 5,5×25 – 12 шт.\n"
                "   • Заглушка пластиковая Ф25 мм – 4шт.\n"
                "   • Прижимные планки – 1 комплект (для фальцевой кровли, крепление 1)."
            ),
            "specs": ["Универсальное крепление"],
            "coating": ["Цинк", "Цинк+краска"],
            "price": {"Цинк": 5700, "Цинк+краска": 6100},
            "photo": "Кровельное ограждение комбинированное СТС «Универсальное» 4 опоры.jpg"
        },
        {
            "id": "2_7",
            "name": "Кровельное ограждение комбинированное СТС «Фальц» 4 опоры",
            "description": (
                "Кровельное ограждение комбинированное СТС «Фальц» 4 опоры, представленное в пяти моделях, имеет длину 3 метра и различные высоты: 60 см с двумя поперечными трубами, 80 см с двумя трубами, 120 см с двумя или тремя трубами и 120 см с четырьмя трубами. Оно подходит для всех типов кровельных материалов и обеспечивает безопасность при работе на крыше.\n\n"
                "Кровельное ограждение комбинированное «Фальц» соответствует требованиям ГОСТ.\n\n"
                "Комплектация:\n"
                "1. Труба оцинкованная Ф25 мм (2, 3, 4) шт. Длина – 3 м.\n"
                "2. Кронштейн ограждения «СТС» оцинкованный, толщина металла 2 мм – 8 шт.\n"
                "3. Стойка ограждения 45×30 оцинкованная, толщина металла 2 мм (600, 800, 1200) – 4 шт.\n"
                "4. Упор 600×30×30 оцинкованный, толщина металла 1,5 мм – 4 шт.\n"
                "5. Укос 30×30 оцинкованный, толщина металла 1,5 мм – 1 шт.\n"
                "6. Крепеж сборочный – 1 комплект:\n"
                "   • Стыковочные планки – 2 шт.\n"
                "   • Болт М10×20 + гайка М10 – 5 шт.\n"
                "   • Болт М8 + гайка М8 – 16 шт.\n"
                "   • Саморез 5,5×25 – 21 шт.\n"
                "   • Заглушка пластиковая Ф25 мм – 4 шт.\n"
                "7. Прижимные планки – 1 комплект – 8 шт."
            ),
            "specs": ["Фальцевая кровля"],
            "coating": ["Цинк", "Цинк+краска"],
            "price": {"Цинк": 5800, "Цинк+краска": 6200},
            "photo": "Кровельное ограждение комбинированное СТС «Фальц» 4 опоры.jpg"
        },
        {
            "id": "2_8",
            "name": "Кровельное ограждение комбинированное СТС «Универсальное» 3 опоры",
            "description": (
                "Кровельное ограждение комбинированное СТС «Универсальное» 3 опоры. Доступно в пяти различных вариантах. Все модели длиной 3 метра, но имеют разную высоту: 60 см – 2 поперечных трубы, 80 см – 2 трубы, 1,2 м – 2 или 3 трубы, а также 1,2 м с 4 трубами. Эконом-класс.\n\n"
                "Кровельное ограждение соответствует требованиям ГОСТ.\n\n"
                "Комплектация:\n"
                "1. Труба оцинкованная Ф25 мм (2, 3, 4) шт.\n"
                "2. Кронштейн ограждения «СТС» оцинкованный, толщина металла 1,5 мм – 4 шт.\n"
                "3. Стойка ограждения 45×30 оцинкованная, толщина металла 2 мм (600, 800, 1200) – 4 шт.\n"
                "4. Укос 30×30 оцинкованный, толщина металла 1,5 мм – 1 шт.\n"
                "5. Крепеж – 1 комплект:\n"
                "   • Саморез для крепления лаг и реек 8×60 – 6 шт.\n"
                "   • Резиновая прокладка 30×10 – 6 шт.\n"
                "   • Стыковочные планки – 2 шт.\n"
                "   • Болт М10×20 + гайка М10 – 7 шт.\n"
                "   • Саморез 5,5×25 – 9 шт.\n"
                "   • Заглушка пластиковая Ф25 мм – 4шт.\n"
                "   • Прижимные планки – 1 комплект (для фальцевой кровли, крепление 1)."
            ),
            "specs": ["Универсальное крепление"],
            "coating": ["Цинк", "Цинк+краска"],
            "price": {"Цинк": 5900, "Цинк+краска": 6300},
            "photo": "Кровельное ограждение комбинированное СТС «Универсальное» 3 опоры.jpg"
        },
        {
            "id": "2_9",
            "name": "Кровельное ограждение комбинированное СТС «Фальц» 3 опоры",
            "description": (
                "Кровельное ограждение комбинированное СТС «Фальц» 3 опоры также доступно в пяти вариантах с длиной 3 метра и различной высотой: 60 сантиметров – 2 поперечных трубы; 80 сантиметров – 2 трубы; 120 сантиметров – две или три трубы, а также 1.2 метра с 4 трубами. Подходит для фальцевой кровли. Эконом-вариант.\n\n"
                "Кровельное ограждение комбинированное «Фальц» соответствует требованиям ГОСТ.\n\n"
                "Комплектация:\n"
                "1. Труба оцинкованная Ф25 мм (2, 3, 4) шт. Длина – 3 м.\n"
                "2. Кронштейн ограждения «СТС» оцинкованный, толщина металла 2 мм – 6 шт.\n"
                "3. Стойка ограждения 45×30 оцинкованная, толщина металла 2 мм (600, 800, 1200) – 3 шт.\n"
                "4. Упор 600×30×30 оцинкованный, толщина металла 1,5 мм – 3 шт.\n"
                "5. Укос 30×30 оцинкованный, толщина металла 1,5 мм – 1 шт.\n"
                "6. Крепеж сборочный – 1 комплект:\n"
                "   • Стыковочные планки – 2 шт.\n"
                "   • Болт М10×20 + гайка М10 – 4 шт.\n"
                "   • Болт М8 + гайка М8 – 12 шт.\n"
                "   • Саморез 5,5×25 – 17 шт.\n"
                "   • Заглушка пластиковая Ф25 мм – 4 шт.\n"
                "7. Прижимные планки – 1 комплект – 6 шт."
            ),
            "specs": ["Фальцевая кровля"],
            "coating": ["Цинк", "Цинк+краска"],
            "price": {"Цинк": 6000, "Цинк+краска": 6400},
            "photo": "Кровельное ограждение комбинированное СТС «Фальц» 3 опоры.jpg"
        },
        {
            "id": "2_10",
            "name": "Кровельное ограждение парапетное СТС «В»",
            "description": (
                "Кровельное ограждение парапетное СТС «В» представлено в 5 моделях длиной 3 000 мм и различной высотой: 600 мм — 2 поперечные трубы, 800 мм — 2 или 3 поперечные трубы и 1 200 мм — 2 или 3 поперечные трубы. Подходит для всех видов кровель и обеспечивает безопасность во время работы на крыше. Вертикальный кронштейн крепления к парапету.\n\n"
                "Кровельное ограждение парапетное соответствует требованиям ГОСТ.\n\n"
                "Комплектация:\n"
                "1. Труба оцинкованная Ф25 мм – 2 шт. или 3 шт.\n"
                "2. Кронштейн ограждения «ПРОФ» В оцинкованный, толщина метала 2 мм с герметичной бутил-каучуковой лентой у основания – 3 шт.\n"
                "3. Стойка ограждения 45×30 оцинкованная, толщина металла 2 мм (600, 800, 1200) – 3 шт.\n"
                "4. Укос 30×30 оцинкованный, толщина металла 1,5 мм – 1 шт.\n"
                "5. Крепеж сборочный – 1 комплект:\n"
                "   • Стыковочные планки – 2, 3 шт.\n"
                "   • Болт М10×20 + гайка М10 – 7 шт.\n"
                "   • Саморез 5,5×25 – 9 шт."
            ),
            "specs": ["Парапетное крепление"],
            "coating": ["Цинк", "Цинк+краска"],
            "price": {"Цинк": 6100, "Цинк+краска": 6500},
            "photo": "Кровельное ограждение парапетное СТС «В».jpg"
        },
        {
            "id": "2_11",
            "name": "Кровельное ограждение парапетное СТС «Г»",
            "description": (
                "Кровельное ограждение парапетное СТС «Г» представлено в 6 моделях длиной 3 000 мм и различной высотой: 600 мм — 2 поперечные трубы, 800 мм — две или 3 поперечные трубы, и 1 200 мм — от 2 до 4 поперечных труб. Подходит для всех видов кровель и обеспечивает безопасность во время работы на крыше. Горизонтальный кронштейн крепления к парапету.\n\n"
                "Кровельное ограждение соответствует требованиям ГОСТ.\n\n"
                "Комплектация:\n"
                "1. Труба оцинкованная Ф25 мм – 2 шт. или 3 шт.\n"
                "2. Кронштейн ограждения «ПРОФ» Г оцинкованный, толщина метала 2 мм с герметичной бутил-каучуковой лентой у основания – 3 шт.\n"
                "3. Стойка ограждения 45×30 оцинкованная, толщина металла 2 мм (600, 800, 1200) – 3 шт.\n"
                "4. Укос 30×30 оцинкованный, толщина металла 1,5 мм – 1 шт.\n"
                "5. Крепеж сборочный – 1 комплект:\n"
                "   • Стыковочные планки – 2 шт.\n"
                "   • Болт М10×20 + гайка М10 – 7 шт.\n"
                "   • Саморез 5,5×25 – 9 шт."
            ),
            "specs": ["Парапетное крепление"],
            "coating": ["Цинк", "Цинк+краска"],
            "price": {"Цинк": 6200, "Цинк+краска": 6600},
            "photo": "Кровельное ограждение парапетное СТС «Г».jpg"
        },
        {
            "id": "2_12",
            "name": "Кровельное ограждение СТС «ПРОФ» для плоских кровель 3 опоры",
            "description": (
                "Кровельное ограждение СТС «ПРОФ» для плоских кровель 3 опоры также доступно в шести вариантах с длиной 3 метра и различной высотой: 0,6 метра – 2 поперечных трубы; 0,8 метра – 2 или 3 трубы; 1,2 метра – от 2 до 4 поперечных трубы. Ограждение подходит для всех видов покрытий плоских кровель.\n\n"
                "Кровельное ограждение для плоских кровель соответствует требованиям ГОСТ.\n\n"
                "Комплектация:\n"
                "1. Труба оцинкованная Ф25 мм – 2 шт. или 3 шт.\n"
                "2. Кронштейн ограждения «ПРОФ» Г оцинкованный, толщина метала 2 мм с герметичной бутил-каучуковой лентой у основания – 3 шт.\n"
                "3. Стойка ограждения 45×30, толщина металла 2 мм. (600, 800, 1200) – 3 шт.\n"
                "4. Укос 30×30 оцинкованный, толщина металла 1,5 мм – 1 шт.\n"
                "5. Крепеж сборочный – 1 комплект:\n"
                "   • Стыковочные планки – 2 шт.\n"
                "   • Болт М10×20 + гайка М10 – 7 шт.\n"
                "   • Саморез 5,5×25 – 9 шт."
            ),
            "specs": ["Плоская кровля"],
            "coating": ["Цинк", "Цинк+краска"],
            "price": {"Цинк": 6300, "Цинк+краска": 6700},
            "photo": "Кровельное ограждение СТС «ПРОФ» для плоских кровель 3 опоры.jpg"
        }
    ],
    "3": [
        {
            "id": "3_1",
            "name": "Площадка выхода на кровлю ЛП/СТС/800",
            "description": (
                "Площадка выхода на кровлю здания ЛП/СТС/800 размером 800x1000x1200 мм, изготовленная из оцинкованного металла.\n\n"
                "Обеспечивает безопасный и комфортный доступ к крыше для проведения необходимых работ и обслуживания.\n\n"
                "Площадка выхода на кровлю соответствует требованиям ГОСТ.\n\n"
                "Типы кровельных покрытий для которых подходить площадка для пожарной лестницы:\n"
                "• Битумные наплавляемые\n"
                "• ПВХ-мембраны\n"
                "• Сэндвич-панели\n"
                "• Профнастил\n"
                "• Металлочерепица\n"
                "• Фальц"
            ),
            "specs": ["Стандартная"],
            "coating": ["Цинк", "Цинк+краска"],
            "price": {"Цинк": 7200, "Цинк+краска": 7600},
            "photo": "Площадка выхода на кровлю ЛП/СТС/800.jpg"
        },
        {
            "id": "3_2",
            "name": "Лестница пожарная ЛП/СТС/800 (без площадки)",
            "description": (
                "Лестница пожарная ЛП/СТС/800 без площадки размером 800×1000 мм с четырьмя кронштейнами для крепления к стене или другой вертикальной поверхности. Соответствует всем требованиям пожарной безопасности. Обеспечивает быстрый и безопасный доступ на верхние этажи здания в случае возникновения пожара.\n\n"
                "Лестница пожарная соответствует требованиям ГОСТ.\n\n"
                "Типы кровельных покрытий для которых подходить наши пожарные лестницы:\n"
                "• Битумные наплавляемые\n"
                "• ПВХ-мембраны\n"
                "• Сэндвич-панели\n"
                "• Профнастил\n"
                "• Металлочерепица\n"
                "• Фальц"
            ),
            "specs": ["Стандартная"],
            "coating": ["Цинк", "Цинк+краска"],
            "price": {"Цинк": 7300, "Цинк+краска": 7700},
            "photo": "Лестница пожарная ЛП/СТС/800 (без площадки).jpg"
        }
    ],
    "4": [
        {
            "id": "4_1",
            "name": "Лестница стеновая СТС",
            "description": (
                "Лестница стеновая СТС доступна в двух вариантах длиной 2 000 мм и 3 000 мм. Оба изделия обеспечивают безопасный и удобный доступ на крышу, идеально подходит для всех видов кровель. Ширина лестницы – 400 мм.\n\n"
                "Лестница соответствует требованиям ГОСТ.\n\n"
                "Комплектация:\n"
                "1. Лестничное полотно 400×2000 (1800)\n"
                "2. Кронштейн крепления к кровле сборный Zn с бутил-каучуковой лентой – 6 шт.\n"
                "3. Крепеж для сборки – 1 комплект.\n"
                "   • Саморез для для крепления лаг и реек 8×60 – 12 шт.\n"
                "   • Саморез 5,5×25 – 32 шт."
            ),
            "specs": ["Стандартная"],
            "coating": ["Цинк", "Цинк+краска"],
            "price": {"Цинк": 8200, "Цинк+краска": 8600},
            "photo": "Лестница стеновая СТС.jpg"
        },
        {
            "id": "4_2",
            "name": "Лестница кровельная СТС «Универсальный»",
            "description": (
                "Лестница кровельная СТС «Универсальный» доступна в двух вариантах с одинаковой шириной – 400 мм. Первый вариант имеет длину 2 000 мм, а второй – 3 000 мм. Оба изделия обеспечивают безопасный и удобный доступ на крышу, идеально подходят для использования на всех видах кровли.\n\n"
                "Лестница соответствует требованиям ГОСТ.\n\n"
                "Комплектация:\n"
                "1. Лестничное полотно 400×3000 (1800)\n"
                "2. Кронштейн крепления к кровле сборный Zn с бутил-каучуковой лентой – 6 шт.\n"
                "3. Крепеж для сборки – 1 комплект.\n"
                "   • Саморез для для крепления лаг и реек 8×60 – 12 шт.\n"
                "   • Саморез 5,5×25 – 32 шт."
            ),
            "specs": ["Универсальное крепление"],
            "coating": ["Цинк", "Цинк+краска"],
            "price": {"Цинк": 8300, "Цинк+краска": 8700},
            "photo": "Лестница кровельная СТС «Универсальный».jpg"
        },
        {
            "id": "4_3",
            "name": "Лестница кровельная СТС «ПРОФ»",
            "description": (
                "Лестница кровельная СТС «ПРОФ» разработана специально для кровель из профнастила выше НС40 и сендвич-панели любого производителя. Доступна в четырех различных вариантах, но все модели имеют одинаковую ширину – 400 миллиметров. Высота каждой модели индивидуальна: 2 метра – 6 кронштейнов; 3 метра – 8 кронштейнов. Кронштейн обеспечивает надежное крепление лестницы к поверхности крыши.\n\n"
                "Лестница кровельная соответствует требованиям ГОСТ.\n\n"
                "Комплектация:\n"
                "1. Лестничное полотно 400×3000 (1800)\n"
                "2. Кронштейн крепления к кровле сборный Zn с бутил-каучуковой лентой – 6 шт.\n"
                "3. Крепеж для сборки – 1 комплект.\n"
                "   • Саморез для для крепления лаг и реек 8×60 – 12 шт.\n"
                "   • Саморез 5,5×25 – 32 шт."
            ),
            "specs": ["Профнастил", "Сэндвич-панели"],
            "coating": ["Цинк", "Цинк+краска"],
            "price": {"Цинк": 8400, "Цинк+краска": 8800},
            "photo": "Лестница кровельная СТС «ПРОФ».jpg"
        },
        {
            "id": "4_4",
            "name": "Лестница кровельная СТС «Фальц»",
            "description": (
                "Лестница кровельная СТС «Фальц» представлена в двух вариантах. Ширина обоих моделей составляет 400 мм. Длина первой модели – 2 000 мм, количество кронштейнов – 6. Длина второй модели – 3 000 мм, количество кронштейнов – 8. Подходят для всех видов кровельных материалов. Обеспечивают безопасный и комфортный доступ на крышу.\n\n"
                "Лестница соответствует требованиям ГОСТ.\n\n"
                "Комплектация:\n"
                "1. Лестничное полотно 400×3000 (1800)\n"
                "2. Кронштейн крепления к кровле сборный Zn с бутил-каучуковой лентой – 6 шт.\n"
                "3. Крепеж для сборки – 1 комплект.\n"
                "   • Саморез для для крепления лаг и реек 8×60 – 12 шт.\n"
                "   • Саморез 5,5×25 – 32 шт.\n"
                "4. Для фальцевой кровли прижимные планки – 1 комплект."
            ),
            "specs": ["Фальцевая кровля"],
            "coating": ["Цинк", "Цинк+краска"],
            "price": {"Цинк": 8500, "Цинк+краска": 8900},
            "photo": "Лестница кровельная СТС «Фальц».jpg"
        }
    ],
    "5": [
        {
            "id": "5_1",
            "name": "Мостик кровельный СТС «ПРОФ»",
            "description": (
                "Мостик кровельный СТС «ПРОФ» предназначен для кровель из профнастила выше НС40 и сендвич-панел. Предлагается в трех различных длинах: 2500 мм, 1250 мм и 600 мм. Все модели имеют одинаковую ширину – 300 миллиметров. Количество опорных кронштейнов зависит от длины мостика: 4 кронштейна для 2,5-метровой модели, 3 кронштейна для 1,25-метровой и 2 кронштейна для 600-милиметровой. Опорные кронштейны обеспечивают надежное крепление мостика к кровле.\n\n"
                "Кровельные мостик соответствует требованиям ГОСТ.\n\n"
                "Комплектация:\n"
                "1. Полотно 300 мм × (2500, 1250, 600 мм.) – 1 шт.\n"
                "2. Кронштейн «СТС» оцинкованный толщина метала 2 мм – 4 шт. (3шт., 2 шт.)\n"
                "3. Кронштейн «СТС» регулировочный оцинкованный толщина метала 2 мм – 4 шт. (3шт., 2 шт.)\n"
                "4. Крепеж – 1 комплект:\n"
                "   • Саморез для крепления лаг и реек 6×80 – 8 шт. (6 шт., 4 шт.)\n"
                "   • Резиновая прокладка 3×10 мм – 8 шт. (6 шт., 4 шт.)\n"
                "   • Болт М10×20 + гайка М10 – 24 шт. (18 шт., 12 шт.)"
            ),
            "specs": ["Профнастил", "Сэндвич-панели"],
            "coating": ["Цинк", "Цинк+краска"],
            "price": {"Цинк": 9200, "Цинк+краска": 9600},
            "photo": "Мостик кровельный СТС «ПРОФ».jpg"
        },
        {
            "id": "5_2",
            "name": "Мостик кровельный СТС «Универсальный»",
            "description": (
                "Мостик кровельный СТС «Универсальный» подходит для всех видов кровельных материалов. Предлагается в трех различных длинах: 2500 мм, 1250 мм и 600 мм. Все модели имеют одинаковую ширину – 300 миллиметров. Количество опорных кронштейнов зависит от длины мостика: 4 кронштейна для 2,5-метровой модели, 3 кронштейна для 1,25-метровой и 2 кронштейна для 60-сантиметровой. Опорные кронштейны обеспечивают надежное крепление мостика к кровле.\n\n"
                "Кровельные мостик соответствует требованиям ГОСТ.\n\n"
                "Комплектация:\n"
                "1. Полотно 300 мм × (2500, 1250, 600 мм.) – 1 шт.\n"
                "2. Кронштейн «СТС» оцинкованный толщина метала 2 мм – 4 шт. (3шт., 2 шт.)\n"
                "3. Кронштейн «СТС» регулировочный оцинкованный толщина метала 2 мм – 4 шт. (3шт., 2 шт.)\n"
                "4. Крепеж – 1 комплект:\n"
                "   • Саморез для крепления лаг и реек 6×80 – 8 шт. (6 шт., 4 шт.)\n"
                "   • Резиновая прокладка 3×10 мм – 8 шт. (6 шт., 4 шт.)\n"
                "   • Болт М10×20 + гайка М10 – 24 шт. (18 шт., 12 шт.)"
            ),
            "specs": ["Универсальное крепление"],
            "coating": ["Цинк", "Цинк+краска"],
            "price": {"Цинк": 9300, "Цинк+краска": 9700},
            "photo": "Мостик кровельный СТС «Универсальный».jpg"
        },
        {
            "id": "5_3",
            "name": "Мостик кровельный СТС «Фальц»",
            "description": (
                "Мостик кровельный СТС «Фальц» конструкция разработана специально для фальцевых видов кровли. Доступны в трёх различных вариантах. Рабочая ширина для всех моделей составляет 300 мм. Однако, длина может варьироваться: 2500 мм с 4 опорными кронштейнами, 1250 мм с 3 опорными кронштейнами и 600 мм с двумя опорными кронштейнами. Эти мостики идеально подходят для фальцевых типов кровли.\n\n"
                "Кровельные мостик соответствует требованиям ГОСТ.\n\n"
                "Комплектация:\n"
                "1. Полотно 300 мм × (2500, 1250, 600 мм.) – 1 шт.\n"
                "2. Кронштейн «СТС» оцинкованный толщина метала 2 мм – 4 шт. (3шт., 2 шт.)\n"
                "3. Кронштейн «СТС» регулировочный оцинкованный толщина метала 2 мм – 4 шт. (3шт., 2 шт.)\n"
                "4. Крепеж – 1 комплект:\n"
                "   • Саморез для крепления лаг и реек 6×80 – 8 шт. (6 шт., 4 шт.)\n"
                "   • Резиновая прокладка 3×10 мм – 8 шт. (6 шт., 4 шт.)\n"
                "   • Болт М10×20 + гайка М10 – 24 шт. (18 шт., 12 шт.)\n"
                "5. Прижимные планки – 1 комплект. (для фальцевой кровли, крепление 2)"
            ),
            "specs": ["Фальцевая кровля"],
            "coating": ["Цинк", "Цинк+краска"],
            "price": {"Цинк": 9400, "Цинк+краска": 9800},
            "photo": "Мостик кровельный СТС «Фальц».jpg"
        },
        {
            "id": "5_4",
            "name": "Ограждение к кровельному мостику СТС",
            "description": (
                "Ограждение к кровельному мостику СТС представлено в 11 вариантах длиной 600, 1250 и 2500 мм и различной высотой: 600 и 800 мм — 2 поперечные трубы, 1 200 мм — от 2 до 3 поперечных труб. Подходит для всех видов кровельных мостиком нашей компании и обеспечивает безопасность во время работы на крыше.\n\n"
                "Ограждение соответствует требованиям ГОСТ.\n\n"
                "Комплектация:\n"
                "1. Стойка ограждения 1200 (800, 600) – 4 (3, 2) шт.\n"
                "2. Труба Ф25 мм Zn 2500 (1250, 600) – 2 шт."
            ),
            "specs": ["Стандартное"],
            "coating": ["Цинк", "Цинк+краска"],
            "price": {"Цинк": 9500, "Цинк+краска": 9900},
            "photo": "Ограждение к кровельному мостику СТС.jpg"
        }
    ]
}

# Глобальные переменные для хранения состояния
user_carts = {}  # Корзины пользователей
user_states = {}  # Текущие состояния пользователей
user_selections = {}  # Выборы пользователей

# ========== ФОРМАТИРОВАНИЕ СООБЩЕНИЙ ==========
def format_product_message(product, selected_options=None):
    message = f"📦 <b>{product['name']}</b>\n\n"
    message += f"📝 <i>{product['description']}</i>\n\n"
    
    if selected_options:
        for option, value in selected_options.items():
            if option == "Цвет, RAL Classic" and value == "Не выбрано":
                continue
            message += f"🔹 {option}: {value}\n"
    
    if 'price' in product:
        if isinstance(product['price'], dict):
            if selected_options and 'Защитное покрытие' in selected_options:
                coating = selected_options['Защитное покрытие']
                price = product['price'].get(coating, 0)
                message += f"\n💰 Цена: {price} руб./шт\n"
            else:
                message += "\n💰 Цены:\n"
                for coating, price in product['price'].items():
                    message += f"  • {coating}: {price} руб./шт\n"
        else:
            message += f"💰 Цена: {product['price']} руб./шт\n"
    
    return message
# ========== ОСНОВНЫЕ КОМАНДЫ ==========
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)
    user_carts[user_id] = []  # Инициализация корзины
    user_states[user_id] = "MAIN_MENU"  # Установка состояния
    user_selections[user_id] = {}  # Сброс выбора пользователя
    
    keyboard = [
        [InlineKeyboardButton("🏢 О компании", callback_data="about")],
        [InlineKeyboardButton("📚 Каталог", callback_data="catalog")],
        [InlineKeyboardButton("📞 Контакты", callback_data="contacts")]
    ]
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    welcome_text = (
        "👋 Вас приветствует официальный бот продаж продукции ООО «СТС»!\n\n"
        "Мы предлагаем элементы безопасности на ВСЕ типы кровель, цены завода изготовителя, "
        "отгрузка от 1 дня. Воспользуйтесь нашим онлайн-решением для удобного "
        "формирования заявок на покупку продукции!"
    )
    
    if update.message:
        await update.message.reply_text(welcome_text, reply_markup=reply_markup)
    else:
        query = update.callback_query
        await query.answer()
        await query.edit_message_text(welcome_text, reply_markup=reply_markup)

async def about_company(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    about_text = (
        "🏢 <b>О компании</b>\n\n"
        "Компания ООО «СТС» работает в области производства элементов безопасности кровли с 2014 года.\n\n"
        "Мы применяем высокоточные станки, а на нашем производстве задействованы специалисты с опытом от 5 лет.\n\n"
        "Мы осуществляем бесплатную доставку до терминала транспортной компании в вашем городе.\n\n"
        "🌐 Официальный сайт: <a href='http://эбк-стс.рф'>эбк-стс.рф</a>"
    )
    
    keyboard = [[InlineKeyboardButton("🔙 Назад", callback_data="back_to_main")]]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await query.edit_message_text(about_text, reply_markup=reply_markup, parse_mode="HTML")

async def contacts(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    contacts_text = (
        "📞 <b>Контакты</b>\n\n"
        "Наш e-mail: ctcnet@yandex.ru\n\n"
        "Задайте вопрос, и мы свяжемся с вами в ближайшее время!"
    )
    
    keyboard = [
        [InlineKeyboardButton("📩 Задать вопрос", callback_data="ask_question")],
        [InlineKeyboardButton("🔙 Назад", callback_data="back_to_main")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await query.edit_message_text(contacts_text, reply_markup=reply_markup, parse_mode="HTML")

# ========== КАТАЛОГ И КОРЗИНА ==========
async def show_catalog(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    user_id = str(query.from_user.id)
    user_states[user_id] = "CATALOG"
    
    keyboard = [
        [InlineKeyboardButton(cat["name"], callback_data=f"cat_{cat['id']}")]
        for cat in categories
    ]
    keyboard.append([InlineKeyboardButton("🔙 Назад", callback_data="back_to_main")])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    await query.edit_message_text("📚 <b>Каталог продукции</b>\n\nВыберите категорию:", 
                                reply_markup=reply_markup, 
                                parse_mode="HTML")

async def show_category_products(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    category_id = query.data.split("_")[1]
    user_id = str(query.from_user.id)
    user_states[user_id] = f"CATEGORY_{category_id}"
    
    if category_id not in products:
        await query.edit_message_text("⚠️ Товары в этой категории временно отсутствуют.")
        return
    
    keyboard = [
        [InlineKeyboardButton(product["name"], callback_data=f"prod_{product['id']}")]
        for product in products[category_id]
    ]
    keyboard.append([InlineKeyboardButton("🔙 Назад", callback_data="catalog")])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    await query.edit_message_text(f"🏷 <b>{categories[int(category_id)-1]['name']}</b>\n\nВыберите модель:", 
                                reply_markup=reply_markup, 
                                parse_mode="HTML")

async def show_product(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    product_id = query.data.split("_")[1]
    user_id = str(query.from_user.id)
    user_states[user_id] = f"PRODUCT_{product_id}"
    
    # Упрощенный поиск продукта по ID
    product = None
    for category in products.values():
        for item in category:
            if item['id'] == product_id:
                product = item
                break
        if product:
            break
    
    if product is None:
        await query.edit_message_text("⚠️ Произошла ошибка при загрузке товара")
        return
    
    # Сохраняем текущий продукт для пользователя
    user_selections[user_id] = {
        "product_id": product_id,
        "product": product,
        "selected_options": {}
    }
    
    # Создаем кнопки для выбора характеристик
    keyboard = [
        [InlineKeyboardButton("📄 Описание", callback_data=f"show_desc_{product_id}")]
    ]
    
    # Кнопка для выбора спецификации (если есть варианты)
    if 'specs' in product and product['specs']:
        keyboard.append([InlineKeyboardButton("📌 Выбрать спецификацию", callback_data=f"spec_{product_id}")])
    
    # Кнопка для выбора покрытия (если есть варианты)
    if 'coating' in product and product['coating']:
        keyboard.append([InlineKeyboardButton("🎨 Выбрать покрытие", callback_data=f"select_coating_{product_id}_0")])
    
    # Основные кнопки
    keyboard.append([InlineKeyboardButton("🛒 Добавить в корзину", callback_data=f"add_to_cart_{product_id}")])
    keyboard.append([InlineKeyboardButton("🔙 Назад", callback_data=f"cat_{product_id.split('_')[0]}")])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    # Формируем краткое сообщение о товаре
    message = f"<b>{product['name']}</b>\n\n"
    message += "ℹ️ Нажмите кнопку 'Описание', чтобы увидеть полную информацию о товаре"
    
    # Отправляем сообщение с информацией о товаре
    await query.edit_message_text(
        message,
        reply_markup=reply_markup,
        parse_mode="HTML"
    )

async def show_description(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    product_id = query.data.split("_")[2]
    user_id = str(query.from_user.id)
    
    # Получаем сохраненный продукт
    product = user_selections[user_id]["product"]

    # Формируем полное описание с использованием существующей функции
    message = format_product_message(product)

    # Кнопка возврата
    keyboard = [
        [InlineKeyboardButton("🔙 Назад", callback_data=f"prod_{product_id}")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    await query.edit_message_text(
        message,
        reply_markup=reply_markup,
        parse_mode="HTML"
    )

async def select_specification(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    product_id = query.data.split("_")[1]
    user_id = str(query.from_user.id)
    
    product = None
    for cat in products.values():
        for p in cat:
            if p['id'] == product_id:
                product = p
                break
        if product:
            break
    
    if not product:
        await query.edit_message_text("⚠️ Товар не найден.")
        return
    
    keyboard = [
        [InlineKeyboardButton(spec, callback_data=f"select_spec_{product_id}_{i}")]
        for i, spec in enumerate(product['specs'])
    ]
    keyboard.append([InlineKeyboardButton("🔙 Назад", callback_data=f"prod_{product_id}")])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    await query.edit_message_text(
        "📌 Выберите спецификацию:",
        reply_markup=reply_markup
    )

async def handle_spec_selection(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    _, product_id, spec_index = query.data.split("_")[1:]
    spec_index = int(spec_index)
    user_id = str(query.from_user.id)
    
    product = None
    for cat in products.values():
        for p in cat:
            if p['id'] == product_id:
                product = p
                break
        if product:
            break
    
    if not product:
        await query.edit_message_text("⚠️ Товар не найден.")
        return
    
    # Сохраняем выбранную спецификацию
    user_selections[user_id]["selected_options"]["Спецификация"] = product['specs'][spec_index]
    
    # Переходим к выбору покрытия
    keyboard = [
        [InlineKeyboardButton(coating, callback_data=f"select_coating_{product_id}_{i}")]
        for i, coating in enumerate(product['coating'])
    ]
    keyboard.append([InlineKeyboardButton("🔙 Назад", callback_data=f"spec_{product_id}")])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    await query.edit_message_text(
        "🛡 Выберите защитное покрытие:",
        reply_markup=reply_markup
    )

async def handle_coating_selection(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    _, product_id, coating_index = query.data.split("_")[1:]
    coating_index = int(coating_index)
    user_id = str(query.from_user.id)
    
    product = None
    for cat in products.values():
        for p in cat:
            if p['id'] == product_id:
                product = p
                break
        if product:
            break
    
    if not product:
        await query.edit_message_text("⚠️ Товар не найден.")
        return
    
    # Сохраняем выбранное покрытие
    selected_coating = product['coating'][coating_index]
    user_selections[user_id]["selected_options"]["Защитное покрытие"] = selected_coating
    
    # Если выбрано "Цинк+краска", предлагаем выбрать цвет
    if selected_coating == "Цинк+краска":
        keyboard = [
            [InlineKeyboardButton("Ввести цвет RAL", callback_data=f"enter_ral_{product_id}")],
            [InlineKeyboardButton("🔙 Назад", callback_data=f"select_coating_{product_id}_0")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await query.edit_message_text(
            "🎨 Вы выбрали Цинк+краска. Пожалуйста, укажите цвет по каталогу RAL Classic (четырехзначное число):",
            reply_markup=reply_markup
        )
    else:
        # Переходим к выбору количества
        await select_quantity(update, context, product_id)

async def enter_ral_color(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    product_id = query.data.split("_")[2]
    user_id = str(query.from_user.id)
    user_states[user_id] = f"AWAITING_RAL_{product_id}"
    
    await query.edit_message_text(
        "✏️ Введите четырехзначный код цвета RAL (например, 3005):"
    )

async def select_quantity(update: Update, context: ContextTypes.DEFAULT_TYPE, product_id=None):
    if not product_id:
        query = update.callback_query
        await query.answer()
        product_id = query.data.split("_")[2]
    
    user_id = str(update.effective_user.id)
    user_states[user_id] = f"AWAITING_QUANTITY_{product_id}"
    
    product = None
    for cat in products.values():
        for p in cat:
            if p['id'] == product_id:
                product = p
                break
        if product:
            break
    
    if not product:
        await update.message.reply_text("⚠️ Товар не найден.")
        return
    
    # Если это вызов из handle_coating_selection, используем query
    if hasattr(update, 'callback_query'):
        query = update.callback_query
        await query.edit_message_text(
            "🔢 Введите количество товара (в штуках):"
        )
    else:
        # Если это вызов после ввода RAL цвета
        await update.message.reply_text(
            "🔢 Введите количество товара (в штуках):"
        )

async def handle_quantity_input(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)
    current_state = user_states.get(user_id, "")
    
    if not current_state.startswith("AWAITING_QUANTITY_"):
        return
    
    product_id = current_state.split("_")[2]
    
    try:
        quantity = int(update.message.text)
        if quantity <= 0:
            raise ValueError
    except ValueError:
        await update.message.reply_text("⚠️ Пожалуйста, введите корректное количество (целое число больше 0):")
        return
    
    # Сохраняем количество
    user_selections[user_id]["selected_options"]["Количество"] = quantity
    
    # Рассчитываем итоговую цену
    product = user_selections[user_id]["product"]
    selected_options = user_selections[user_id]["selected_options"]
    
    if 'Защитное покрытие' in selected_options:
        coating = selected_options['Защитное покрытие']
        price_per_item = product['price'].get(coating, 0)
        total_price = price_per_item * quantity
        selected_options["Итоговая цена"] = total_price
    
    # Показываем итоговую информацию
    keyboard = [
        [InlineKeyboardButton("🛒 Добавить в корзину", callback_data=f"confirm_add_{product_id}")],
        [InlineKeyboardButton("🔙 Назад", callback_data=f"prod_{product_id}")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(
        f"✅ Вы выбрали:\n\n{format_product_message(product, user_selections[user_id]['selected_options'])}\n\n"
        f"🔄 Итоговая сумма: {selected_options.get('Итоговая цена', 0)} руб.",
        reply_markup=reply_markup,
        parse_mode="HTML"
    )

async def confirm_add_to_cart(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    product_id = query.data.split("_")[2]
    user_id = str(query.from_user.id)
    
    if user_id not in user_selections or user_selections[user_id]["product_id"] != product_id:
        await query.edit_message_text("⚠️ Ошибка добавления в корзину. Пожалуйста, начните выбор заново.")
        return
    
    # Добавляем товар в корзину
    cart_item = {
        "product": user_selections[user_id]["product"],
        "selected_options": user_selections[user_id]["selected_options"].copy()
    }
    
    if user_id not in user_carts:
        user_carts[user_id] = []
    
    user_carts[user_id].append(cart_item)
    
    # Показываем сообщение об успешном добавлении
    keyboard = [
        [InlineKeyboardButton("📦 Перейти в корзину", callback_data="view_cart")],
        [InlineKeyboardButton("🛒 Продолжить покупки", callback_data="catalog")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await query.edit_message_text(
        "✅ Товар успешно добавлен в корзину!",
        reply_markup=reply_markup
    )

# ========== ОБРАБОТЧИКИ СООБЩЕНИЙ ==========
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)
    current_state = user_states.get(user_id, "MAIN_MENU")
    
    if current_state.startswith("AWAITING_RAL_"):
        product_id = current_state.split("_")[2]
        ral_color = update.message.text.strip()
        
        # Простая валидация RAL цвета (4 цифры)
        if not (ral_color.isdigit() and len(ral_color) == 4):
            await update.message.reply_text("⚠️ Пожалуйста, введите корректный код RAL (четыре цифры):")
            return
        
        user_selections[user_id]["selected_options"]["Цвет, RAL Classic"] = f"RAL {ral_color}"
        await select_quantity(update, context, product_id)
    
    elif current_state.startswith("AWAITING_QUANTITY_"):
        await handle_quantity_input(update, context)
    
    elif current_state == "AWAITING_QUESTION":
        question = update.message.text
        await send_question_to_admin(update, context, question)
        user_states[user_id] = "MAIN_MENU"
        
        keyboard = [[InlineKeyboardButton("🔙 В главное меню", callback_data="back_to_main")]]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await update.message.reply_text(
            "📩 Ваш вопрос отправлен! Мы свяжемся с вами в ближайшее время.",
            reply_markup=reply_markup
        )

async def send_question_to_admin(update: Update, context: ContextTypes.DEFAULT_TYPE, question):
    user = update.effective_user
    message = (
        f"❓ <b>Новый вопрос от пользователя</b>\n\n"
        f"👤 Пользователь: {user.full_name}\n"
        f"📱 Телефон: {user.id}\n\n"
        f"📝 Вопрос:\n{question}"
    )
    
    for admin_id in ADMIN_CHAT_IDS:
        try:
            await context.bot.send_message(
                chat_id=admin_id,
                text=message,
                parse_mode="HTML"
            )
        except Exception as e:
            logger.error(f"Ошибка при отправке вопроса администратору {admin_id}: {e}")

# ========== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ==========
async def back_to_main(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    await start(update, context)

# ========== ЗАПУСК БОТА ==========
def main():
    app = ApplicationBuilder().token(TOKEN).build()
    
    # Обработчики команд
    app.add_handler(CommandHandler("start", start))
    
    # Обработчики callback-запросов
    app.add_handler(CallbackQueryHandler(about_company, pattern="^about$"))
    app.add_handler(CallbackQueryHandler(contacts, pattern="^contacts$"))
    app.add_handler(CallbackQueryHandler(show_catalog, pattern="^catalog$"))
    app.add_handler(CallbackQueryHandler(back_to_main, pattern="^back_to_main$"))
    app.add_handler(CallbackQueryHandler(show_category_products, pattern="^cat_"))
    app.add_handler(CallbackQueryHandler(show_product, pattern="^prod_"))
    app.add_handler(CallbackQueryHandler(select_specification, pattern="^spec_"))
    app.add_handler(CallbackQueryHandler(handle_spec_selection, pattern="^select_spec_"))
    app.add_handler(CallbackQueryHandler(handle_coating_selection, pattern="^select_coating_"))
    app.add_handler(CallbackQueryHandler(enter_ral_color, pattern="^enter_ral_"))
    app.add_handler(CallbackQueryHandler(confirm_add_to_cart, pattern="^confirm_add_"))
    
    # Обработчик текстовых сообщений
    app.add_handler(CallbackQueryHandler(show_description, pattern="^show_desc_"))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    
    # Запуск через Webhook
    app.run_webhook(
        listen="0.0.0.0",
        port=PORT,
        url_path=TOKEN,
        webhook_url=f"https://metalfencingbot.onrender.com/{TOKEN}"
    )

if __name__ == '__main__':
    main()
